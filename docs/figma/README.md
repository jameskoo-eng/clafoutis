# Integrating Clafoutis with Figma

This guide covers how to import design tokens generated by Clafoutis into Figma as variables.

## Generated Artifacts

When a design system uses Clafoutis with the Figma generator, it produces:

| File | Description |
|------|-------------|
| `figma.variables.json` | Figma-compatible variables in JSON format |

The `figma.variables.json` file contains variable collections organized by mode (Light/Dark) with properly transformed values for colors, dimensions, and typography tokens.

---

## Understanding the Output Format

The Figma generator produces a JSON file structured as variable collections:

```json
[
  {
    "name": "Light",
    "modes": [
      {
        "name": "Default",
        "variables": [
          {
            "name": "color/primary",
            "type": "COLOR",
            "value": { "r": 0.231, "g": 0.51, "b": 0.965, "a": 1 }
          },
          {
            "name": "spacing/md",
            "type": "FLOAT",
            "value": 16
          }
        ]
      }
    ]
  },
  {
    "name": "Dark",
    "modes": [
      {
        "name": "Default",
        "variables": [...]
      }
    ]
  }
]
```

### Variable Types

| Token Type | Figma Type | Transformation |
|------------|------------|----------------|
| `color` | `COLOR` | Converted to RGBA (0-1 range) |
| `dimension` | `FLOAT` | Stripped of `px` unit |
| `fontWeight` | `FLOAT` | Converted to numeric (e.g., "bold" → 700) |
| `fontSize` | `FLOAT` | Numeric value |
| `lineHeight` | `FLOAT` | Numeric value |
| `letterSpacing` | `FLOAT` | Numeric value |
| `fontFamily` | `STRING` | Font family name |
| Other | `STRING` | Preserved as string |

---

## Method 1: Using the Tokens Studio Plugin (Recommended)

[Tokens Studio for Figma](https://tokens.studio/) is the most popular method for importing design tokens into Figma.

### Setup

1. Install the **Tokens Studio for Figma** plugin from the Figma Community
2. Open your Figma file and launch the plugin

### Importing Tokens

1. Download `figma.variables.json` from your design system's GitHub Release
2. In Tokens Studio, click **Settings** (gear icon)
3. Select **Import** → **From file**
4. Choose your `figma.variables.json` file
5. Map the collections to your desired Figma variable collections

### Syncing with GitHub (Recommended)

For automated sync, configure Tokens Studio to pull directly from your GitHub repository:

1. In Tokens Studio, go to **Settings** → **Sync providers**
2. Click **Add new** → **GitHub**
3. Configure:
   - **Repository**: `YourOrg/design-system`
   - **Branch**: `main` (or your release branch)
   - **File path**: `build/figma/figma.variables.json`
   - **Personal access token**: A GitHub PAT (see options below)

#### GitHub Token Options

**Option A: Fine-grained PAT (Recommended)**

Fine-grained tokens provide minimal access scoped to specific repositories:

1. Go to **GitHub Settings** → **Developer settings** → **Personal access tokens** → **Fine-grained tokens**
2. Click **Generate new token**
3. Set **Repository access** to **Only select repositories** and choose `YourOrg/design-system`
4. Under **Repository permissions**, set **Contents** to **Read-only**
5. Generate and copy the token

**Option B: Classic PAT**

Classic tokens are simpler but grant broader access:

1. Go to **GitHub Settings** → **Developer settings** → **Personal access tokens** → **Tokens (classic)**
2. Click **Generate new token**
3. Select the `repo` scope (or `public_repo` for public repositories)
4. Generate and copy the token

Now tokens will sync automatically when you open the plugin.

---

## Method 2: Using Figma's Variables REST API

For automated CI/CD integration, you can use Figma's Variables REST API to programmatically update variables.

### Prerequisites

- Figma Enterprise or Organization plan (Variables API requires a paid plan)
- Figma API access token with `file_variables:write` scope

### API Workflow

1. **Get your file key** from the Figma URL: `figma.com/file/{FILE_KEY}/...`

2. **Download the generated `figma.variables.json`** from your design system release

3. **Set environment variables** for your credentials:

```bash
export FIGMA_TOKEN="your-figma-api-token"
export FIGMA_FILE_KEY="your-file-key"
```

> **Security note:** Never hardcode tokens in scripts or documentation. Always use environment variables or a secrets manager.

4. **Transform and POST to Figma API**:

```bash
curl -X POST "https://api.figma.com/v1/files/$FIGMA_FILE_KEY/variables" \
  -H "X-Figma-Token: $FIGMA_TOKEN" \
  -H "Content-Type: application/json" \
  -d @figma-api-payload.json
```

### Transform Script

The Clafoutis output format needs transformation to match Figma's API schema. Here's a Node.js script to convert:

```javascript
import fs from 'fs';

const clafoutisOutput = JSON.parse(fs.readFileSync('figma.variables.json', 'utf8'));

// Transform to Figma API format
const figmaPayload = {
  variableCollections: [],
  variableModes: [],
  variables: [],
  variableModeValues: []
};

clafoutisOutput.forEach((collection, collectionIndex) => {
  const collectionId = `collection_${collectionIndex}`;

  // Pre-pass: Build a stable mapping from variable name to ID and type
  // by collecting all unique variables across all modes
  const variableMap = new Map(); // name -> { id, type }
  let varCounter = 0;

  for (const mode of collection.modes) {
    for (const variable of mode.variables) {
      if (!variableMap.has(variable.name)) {
        variableMap.set(variable.name, {
          id: `var_${collectionIndex}_${varCounter++}`,
          type: variable.type
        });
      } else {
        // Validate type consistency across modes
        const existing = variableMap.get(variable.name);
        if (existing.type !== variable.type) {
          console.warn(
            `Warning: Variable "${variable.name}" has inconsistent types ` +
            `across modes: "${existing.type}" vs "${variable.type}". ` +
            `Using type from first occurrence.`
          );
        }
      }
    }
  }

  figmaPayload.variableCollections.push({
    action: 'CREATE',
    id: collectionId,
    name: collection.name,
    initialModeId: `mode_${collectionIndex}_0`
  });

  // Create all variables from the canonical map
  for (const [name, { id, type }] of variableMap) {
    figmaPayload.variables.push({
      action: 'CREATE',
      id: id,
      name: name,
      variableCollectionId: collectionId,
      resolvedType: type
    });
  }

  // Process each mode
  collection.modes.forEach((mode, modeIndex) => {
    const modeId = `mode_${collectionIndex}_${modeIndex}`;

    figmaPayload.variableModes.push({
      action: 'CREATE',
      id: modeId,
      name: mode.name,
      variableCollectionId: collectionId
    });

    // Track which variables this mode defines
    const modeVariableNames = new Set(mode.variables.map(v => v.name));

    // Warn about variables missing from this mode
    for (const expectedName of variableMap.keys()) {
      if (!modeVariableNames.has(expectedName)) {
        console.warn(
          `Warning: Variable "${expectedName}" is missing from mode ` +
          `"${mode.name}" in collection "${collection.name}". ` +
          `No value will be set for this mode.`
        );
      }
    }

    // Create mode values using the stable variable ID mapping
    for (const variable of mode.variables) {
      const varInfo = variableMap.get(variable.name);
      if (!varInfo) {
        // This shouldn't happen since we built the map from all modes,
        // but handle it defensively
        console.warn(
          `Warning: Unexpected variable "${variable.name}" in mode ` +
          `"${mode.name}". Skipping.`
        );
        continue;
      }

      figmaPayload.variableModeValues.push({
        variableId: varInfo.id,
        modeId: modeId,
        value: variable.value
      });
    }
  });
});

fs.writeFileSync('figma-api-payload.json', JSON.stringify(figmaPayload, null, 2));
console.log('Transformed to Figma API format: figma-api-payload.json');
```

### CI/CD Integration

Add to your GitHub Actions workflow:

```yaml
- name: Sync to Figma
  run: |
    node scripts/transform-figma-variables.js
    curl -X POST "https://api.figma.com/v1/files/${{ secrets.FIGMA_FILE_KEY }}/variables" \
      -H "X-Figma-Token: ${{ secrets.FIGMA_API_TOKEN }}" \
      -H "Content-Type: application/json" \
      -d @figma-api-payload.json
```

---

## Method 3: Manual Import via Copy/Paste

For quick one-time imports or testing:

1. Download `figma.variables.json` from your design system release
2. Open the JSON file and identify the tokens you need
3. In Figma, open **Local variables** panel (right sidebar)
4. Create collections manually (e.g., "Colors", "Spacing")
5. Add variables with values from the JSON

This method is tedious but requires no plugins or API access.

---

## Consumer Workflow

### Using Clafoutis CLI

```bash
# Install Clafoutis
npm install -D clafoutis

# Initialize as consumer
npx clafoutis init --consumer --repo YourOrg/design-system
```

### Configure `.clafoutis/consumer.json`

```json
{
  "repo": "YourOrg/design-system",
  "version": "v1.0.0",
  "files": {
    "figma.variables.json": "./figma/variables.json"
  }
}
```

### Sync Tokens

```bash
npx clafoutis sync
```

The `figma.variables.json` file will be downloaded to `./figma/variables.json`, ready for import into Figma.

---

## Working with Light/Dark Modes

The Figma generator creates separate collections for Light and Dark modes. In Figma:

1. **Using Tokens Studio**: Import both collections, then use the plugin's theming features to switch between modes
2. **Using Variables API**: Create a single collection with multiple modes, mapping Light and Dark as mode variants
3. **Manual**: Create a single collection with "Light" and "Dark" modes, then add variables with different values per mode

### Figma Variable Modes

Figma's native variable system supports modes (variants). For a unified experience:

```text
Collection: "Theme"
├── Mode: "Light"
│   ├── color/background: #FFFFFF
│   └── color/foreground: #1A1A1A
└── Mode: "Dark"
    ├── color/background: #1A1A1A
    └── color/foreground: #FFFFFF
```

You can then apply modes to frames, and all nested elements inherit the mode's values.

---

## Troubleshooting

### Colors look wrong after import

Figma uses 0-1 range for RGBA values. The Clafoutis generator automatically converts from 0-255 to 0-1. If colors appear wrong:

1. Verify your source tokens use standard hex or RGB formats
2. Check the generated `figma.variables.json` for correct value ranges

### Variables not appearing in Figma

1. Ensure you're using Figma's native variables feature (not just styles)
2. Check that your Figma plan supports variables (requires a paid plan for full features)
3. Verify the JSON structure matches Figma's expected format

### Token references not resolved

The Figma generator resolves all token references to concrete values. Figma variables don't support cross-references in the same way design tokens do, so all values are "flattened" to their final computed values.

---

## Additional Resources

- [Figma Variables Documentation](https://help.figma.com/hc/en-us/articles/15339657135383-Guide-to-variables-in-Figma)
- [Figma REST API - Variables](https://www.figma.com/developers/api#variables)
- [Tokens Studio Documentation](https://docs.tokens.studio/)
- [Clafoutis Distribution Guide](../distribution/README.md)
- [Clafoutis Tailwind Guide](../tailwind/README.md)
